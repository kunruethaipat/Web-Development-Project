<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumony | Update Product</title>
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-grid.css">
    <link rel="stylesheet" href="/css/mycss.css">
    <script type="text/javascript" src="/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="/js/bootstrap.bundle.js"></script>
    <script type="text/javascript" src="/js/bootstrap.js"></script>
    <link rel="shortcut icon" type="image/jpg" href="/img/logo.png" />
    <link rel="stylesheet" href="/dist/main.css" />
    <script src="/dist/main.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@100..900&display=swap" rel="stylesheet">
    <!-- เพิ่มฟ้อน -->
    <link href="https://fonts.googleapis.com/css2?family=Spartan:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@400;700&display=swap" rel="stylesheet">
    <!-- เพิ่มicon -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    

</head>

<body class="bgcolor text-white league-spartan100">
    <div class="container-fluid">
        <div class="row">
          <!-- Sidebar -->
        <nav class="col-md-2 d-none d-md-flex bg-sidenav sidebar p-4">
            <div style="margin: 0.7cm;">
                <img src="img/logo.png" alt="Logo" style="width: 100%; max-width: 150px;" class="mb-3">
            </div>
        
            <div>
                <ul class="nav flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white" href="#">Dashboard</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white" href="#">Products</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white" href="#">Orders</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white" href="#">Customers</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white" href="#">Employees</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white" href="#">Analytics</a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link text-white" href="#">Help</a>
                    </li>
                </ul>
            </div>
        
            <ul class="nav flex-column logout-link">
                <li class="nav-item">
                    <a class="nav-link text-white" href="admin_login">Log out</a>
                </li>
            </ul>
        
        </nav>
    
          <!-- Main Content -->
        <main class="col-md-10 ms-sm-auto px-md-4">
            <!-- search bar - profile -->
            <section style="margin: 30px 0; display: flex; justify-content:space-between;">
                <div class="search-bar2">
                    <input class="search_bar_d" type="text" placeholder="SEARCH">
                    <i class="bi bi-search"></i>
                </div>
                <div>
                    <p id="adminInfo" style="font-weight: 300;" class="admininfo-pro">Admin Profile</p>
                </div>
            </section>
    
            <!-- Admin Add Product Page -->
            <div id="productFormPage" class=" py-4">
              <form id="updateProductForm" class="bg-sidenav p-4 rounded" action="/updateProduct" method="POST" enctype="multipart/form-data">
                <div class="back-button2">
                    <i class="bi bi-chevron-left"> </i>
                    <a href="/service_admin"> BACK</a>
                </div>
                <h2 style="margin-top: 0.8cm;" class="h2 mb-3">PRODUCT <span style="color: #06ff87;">UPDATE<span></h2>
                <div class="row g-3">
                    <div class="col-md-12">
                        <input name="productImage" type="file" class="form-control" accept="image/*" onchange="previewImage(event)">
                        <input type="hidden" name="oldImage" id="oldImage">
                        <img id="imagePreview" class="image-preview d-none" alt="Preview" />
                    </div>
                    <div class="col-md-6"><input name="product_ID" class="form-control" placeholder="Product ID" required></div>
                    <div class="col-md-6"><input name="productName" class="form-control" placeholder="Product Name" required></div>
                    <div class="col-md-6"><input name="brand" class="form-control" placeholder="Brand" required></div>
                    <div class="col-md-6"><input name="volume" class="form-control" placeholder="Volume" required></div>
                    <div class="col-md-6"><input name="price" class="form-control" type="number" placeholder="Price" required></div>
                    <div class="col-md-12"><input name="type" class="form-control" placeholder="Type (e.g. Men, Unisex)" required></div>
                    <div class="col-md-12"><textarea name="description" class="form-control" placeholder="Description" rows="3" required></textarea></div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                  <button type="reset" class="btn btn-secondary">Clear</button>
                  <button type="submit" class="btn btn-success text-dark">Save</button>
                </div>
              </form>
            </div>
        </main>
    </div>  
</body>

<script>
    // Auto-fill product details when typing product ID
    document.querySelector('input[name="product_ID"]').addEventListener('blur', function () {
      const productId = this.value.trim();
      if (productId) {
        fetch(`/api/getProduct/${productId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Product not found');
            }
            return response.json();
          })
          .then(product => {
            document.querySelector('input[name="productName"]').value = product.Product_name || '';
            document.querySelector('input[name="brand"]').value = product.Product_brand || '';
            document.querySelector('input[name="volume"]').value = product.Product_volume || '';
            document.querySelector('input[name="price"]').value = product.Product_price || '';
            document.querySelector('input[name="type"]').value = product.Product_type || '';
            document.querySelector('textarea[name="description"]').value = product.Product_description || '';
            
            if (product.Product_image) {
              const imagePreview = document.getElementById('imagePreview');
              imagePreview.src = `data:image/jpeg;base64,${product.Product_image}`;
              imagePreview.classList.remove('d-none');
              document.getElementById('oldImage').value = product.Product_image; // Save old image
            }
          })
          .catch(err => {
            alert(err.message);
            console.log(err);
          });
      }
    });
  
    // Show preview when user chooses a new image
    function previewImage(event) {
      const file = event.target.files[0];
      const preview = document.getElementById('imagePreview');
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
      }
    }
  
    // Handle form submit manually
    document.getElementById('updateProductForm').addEventListener('submit', async function (event) {
      event.preventDefault(); // Prevent normal form POST
  
      const form = event.target;
      const formData = new FormData(form);
  
      const productData = {
        product_ID: formData.get('product_ID'),
        productName: formData.get('productName'),
        brand: formData.get('brand'),
        volume: formData.get('volume'),
        price: formData.get('price'),
        type: formData.get('type'),
        description: formData.get('description'),
        imageUrl: '', // Default
        oldImage: formData.get('oldImage')
      };
  
      const imageFile = formData.get('productImage');
      if (imageFile && imageFile.size > 0) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          productData.imageUrl = e.target.result.split(',')[1]; // Only Base64 part
          await updateProduct(productData);
        };
        reader.readAsDataURL(imageFile);
      } else {
        // No new image, use old
        await updateProduct(productData);
      }
    });
  
    // Send the updated product data to the server
    async function updateProduct(productData) {
      try {
        const response = await fetch('http://localhost:8083/api/updateProduct', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData)
        });
  
        const result = await response.json();
        if (result.success) {
          alert('Product updated successfully!');
          window.location.href = '/service_admin'; // Redirect after success
        } else {
          alert('Failed to update product.');
        }
      } catch (error) {
        console.error('Error updating product:', error);
        alert('Error updating product.');
      }
    }
  </script>
  
</html>
    